<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å—ä¿¡è€…ç®¡ç† - Optec Express</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      background-color: #f1f5f9;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px 16px;
    }
    .container {
      background-color: #ffffff;
      border-radius: 12px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.12);
      overflow: hidden;
    }
    .header {
      background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
      color: white;
      padding: 20px 24px;
    }
    .header h2 { font-size: 18px; font-weight: 600; }
    .header p { font-size: 12px; opacity: 0.8; margin-top: 4px; }
    .body-content { padding: 20px; }
    .awb-info {
      background-color: #f8fafc;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .awb-info-icon { font-size: 24px; }
    .awb-info-label { font-size: 11px; color: #64748b; }
    .awb-info-value { font-size: 15px; font-weight: 600; color: #1a365d; font-family: 'Courier New', monospace; }
    .section-title { font-size: 13px; font-weight: 600; color: #1a365d; margin-bottom: 12px; }
    .recipient-list { margin-bottom: 24px; }
    .recipient-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background-color: #f8fafc;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 1px solid #e2e8f0;
      transition: opacity 0.3s;
    }
    .recipient-item.deleted {
      opacity: 0.4;
      text-decoration: line-through;
      background-color: #fef2f2;
      border-color: #fecaca;
    }
    .recipient-item.new-added {
      background-color: #f0fdf4;
      border-color: #bbf7d0;
    }
    .recipient-info { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
    .recipient-avatar {
      width: 36px; height: 36px;
      background-color: #e2e8f0;
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 14px; font-weight: 600; color: #64748b; flex-shrink: 0;
    }
    .recipient-details { flex: 1; min-width: 0; }
    .recipient-email { font-size: 14px; color: #1e293b; font-weight: 500; word-break: break-all; }
    .recipient-date { font-size: 11px; color: #94a3b8; margin-top: 2px; }
    .recipient-delete {
      background: none; border: none; color: #94a3b8;
      cursor: pointer; padding: 8px; border-radius: 6px;
      font-size: 16px; flex-shrink: 0; transition: all 0.2s;
    }
    .recipient-delete:hover { background-color: #fee2e2; color: #dc2626; }
    .recipient-undo {
      background: none; border: 1px solid #3b82f6; color: #3b82f6;
      cursor: pointer; padding: 4px 10px; border-radius: 6px;
      font-size: 11px; flex-shrink: 0;
    }
    .recipient-undo:hover { background-color: #eff6ff; }
    .add-form {
      background-color: #f8fafc;
      border-radius: 8px;
      padding: 16px;
      border: 1px dashed #cbd5e1;
      margin-bottom: 16px;
    }
    .form-label { display: block; font-size: 12px; font-weight: 500; color: #475569; margin-bottom: 6px; }
    .form-input {
      width: 100%; padding: 10px 14px;
      border: 1px solid #e2e8f0; border-radius: 6px;
      font-size: 14px; outline: none; transition: border-color 0.2s;
    }
    .form-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
    .form-hint { font-size: 11px; color: #94a3b8; margin-top: 6px; }
    .btn-add-email {
      width: 100%; padding: 10px;
      background-color: #f8fafc; color: #1a365d;
      border: 1px solid #cbd5e1; border-radius: 6px;
      font-size: 13px; font-weight: 600; cursor: pointer; margin-top: 10px;
    }
    .btn-add-email:hover { background-color: #e2e8f0; }
    .changes-bar {
      display: none;
      background-color: #fffbeb;
      border: 1px solid #fde68a;
      border-radius: 8px;
      padding: 12px 16px;
      margin-bottom: 16px;
      font-size: 12px;
      color: #92400e;
    }
    .changes-bar.visible { display: block; }
    .footer {
      padding: 16px 24px;
      background-color: #f8fafc;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .footer-note { font-size: 11px; color: #94a3b8; flex: 1; }
    .btn-save {
      padding: 10px 28px;
      background-color: #059669; color: white;
      border: none; border-radius: 6px;
      font-size: 14px; font-weight: 600; cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn-save:hover { background-color: #047857; }
    .btn-save:disabled { background-color: #94a3b8; cursor: not-allowed; }
    .btn-close {
      padding: 10px 20px;
      background-color: #e2e8f0; color: #475569;
      border: none; border-radius: 6px;
      font-size: 13px; font-weight: 500; cursor: pointer;
    }
    .btn-close:hover { background-color: #cbd5e1; }
    .toast {
      display: none; position: fixed; bottom: 24px; left: 50%;
      transform: translateX(-50%); padding: 12px 24px;
      border-radius: 8px; font-size: 14px; font-weight: 500;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 100; color: white;
    }
    .toast.success { background-color: #059669; }
    .toast.error { background-color: #dc2626; }
    .toast.active { display: block; animation: slideUp 0.3s ease-out; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    .loading { text-align: center; padding: 40px; color: #94a3b8; font-size: 14px; }
    .empty-state { text-align: center; padding: 20px; color: #94a3b8; font-size: 13px; }
  </style>
</head>
<body>

<!-- ã‚¨ãƒ©ãƒ¼ç”»é¢ -->
<div class="container" id="error-container" style="display: none;">
  <div class="header">
    <h2 id="err-title">&#x26A0;&#xFE0F; ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹ã§ã™</h2>
  </div>
  <div style="text-align: center; padding: 60px 20px;">
    <p id="err-desc" style="font-size: 14px; color: #64748b; line-height: 1.6;"></p>
  </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
<div class="container" id="main-container" style="display: none;">
  <div class="header">
    <h2 id="hdr-title">&#x1F465;</h2>
    <p id="hdr-subtitle"></p>
  </div>

  <div class="body-content">
    <div class="awb-info">
      <div class="awb-info-icon">&#x1F4E6;</div>
      <div>
        <div class="awb-info-label" id="awb-label"></div>
        <div class="awb-info-value" id="awb-display">---</div>
      </div>
    </div>

    <div class="changes-bar" id="changes-bar"></div>

    <div class="recipient-list">
      <div class="section-title" id="list-title"></div>
      <div id="recipient-container">
        <div class="loading" id="loading-text"></div>
      </div>
    </div>

    <div class="add-form">
      <div class="section-title" id="add-title"></div>
      <div>
        <label class="form-label" id="email-label"></label>
        <input type="email" class="form-input" id="new-email" placeholder="example@company.com">
      </div>
      <div class="form-hint" id="add-hint"></div>
      <button class="btn-add-email" id="btn-add-email" onclick="addEmailLocal()"></button>
    </div>
  </div>

  <div class="footer">
    <div class="footer-note" id="footer-note"></div>
    <button class="btn-close" id="btn-close" onclick="window.close()"></button>
    <button class="btn-save" id="btn-save" onclick="saveChanges()" disabled></button>
  </div>
</div>

<!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
<div class="container" id="loading-container">
  <div class="loading" style="padding: 80px 20px;" id="initial-loading"></div>
</div>

<div class="toast" id="toast"></div>

<script>
  // â˜… GAS Web App URLï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã«æ›´æ–°ï¼‰
  var GAS_URL = 'https://script.google.com/macros/s/AKfycbwCSYW1c40EI7nm8GPm0tHaq2vSfZG0LFPZPYE7RTKZs8hVRWMJW44LKqRjh8Ptk_eQ/exec';

  var params = new URLSearchParams(window.location.search);
  var TOKEN = params.get('token') || '';

  // ===== å¤šè¨€èªè¾æ›¸ =====
  var I18N = {
    page_title:          { ja: 'è¿½è·¡é€šçŸ¥ã®å—ä¿¡è€…ç®¡ç†', en: 'Manage Tracking Recipients', zh: 'è¿½è¸ªé€šçŸ¥æ”¶ä»¶äººç®¡ç†' },
    page_subtitle:       { ja: 'ã“ã®è²¨ç‰©ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚’å—ã‘å–ã‚‹æ–¹ã‚’ç®¡ç†ã§ãã¾ã™', en: 'Manage who receives status updates for this shipment', zh: 'ç®¡ç†è¯¥è´§ç‰©çŠ¶æ€æ›´æ–°çš„æ¥æ”¶äºº' },
    page_awb_label:      { ja: 'å¯¾è±¡AWB', en: 'Target AWB', zh: 'ç›®æ ‡AWB' },
    page_current:        { ja: 'ç¾åœ¨ã®å—ä¿¡è€…', en: 'Current Recipients', zh: 'å½“å‰æ”¶ä»¶äºº' },
    page_no_recipients:  { ja: 'å—ä¿¡è€…ãŒã„ã¾ã›ã‚“', en: 'No recipients', zh: 'æš‚æ— æ”¶ä»¶äºº' },
    page_add_title:      { ja: 'æ–°ã—ã„å—ä¿¡è€…ã‚’è¿½åŠ ', en: 'Add New Recipient', zh: 'æ·»åŠ æ–°æ”¶ä»¶äºº' },
    page_email_label:    { ja: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹', en: 'Email Address', zh: 'é‚®ç®±åœ°å€' },
    page_add_hint:       { ja: 'â€» è¿½åŠ ã•ã‚ŒãŸæ–¹ã«ã¯æ¬¡å›ã®æ›´æ–°ã‹ã‚‰é€šçŸ¥ãŒå±Šãã¾ã™', en: '* Recipients will be notified from the next update', zh: 'â€» æ·»åŠ çš„æ”¶ä»¶äººå°†ä»ä¸‹æ¬¡æ›´æ–°èµ·æ”¶åˆ°é€šçŸ¥' },
    page_add_button:     { ja: 'ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ ', en: '+ Add to List', zh: 'ï¼‹ æ·»åŠ åˆ°åˆ—è¡¨' },
    page_save:           { ja: 'å¤‰æ›´ã‚’ä¿å­˜', en: 'Save Changes', zh: 'ä¿å­˜æ›´æ”¹' },
    page_cancel:         { ja: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', en: 'Cancel', zh: 'å–æ¶ˆ' },
    page_close:          { ja: 'é–‰ã˜ã‚‹', en: 'Close', zh: 'å…³é—­' },
    page_security:       { ja: 'ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚ã€ã“ã®ãƒªãƒ³ã‚¯ã¯15æ—¥é–“æœ‰åŠ¹ã§ã™', en: 'ğŸ”’ This link is valid for 15 days', zh: 'ğŸ”’ å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œæ­¤é“¾æ¥æœ‰æ•ˆæœŸä¸º15å¤©' },
    page_unsaved:        { ja: 'âš  æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Šã¾ã™ã€‚ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚', en: 'âš  You have unsaved changes. Press "Save Changes".', zh: 'âš  æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œè¯·ç‚¹å‡»"ä¿å­˜æ›´æ”¹"ã€‚' },
    page_added_date:     { ja: 'è¿½åŠ æ—¥', en: 'Added', zh: 'æ·»åŠ æ—¥æœŸ' },
    page_from_link:      { ja: 'ãƒ¡ãƒ¼ãƒ«ãƒªãƒ³ã‚¯ã‹ã‚‰è¿½åŠ ', en: 'Added via email link', zh: 'é€šè¿‡é‚®ä»¶é“¾æ¥æ·»åŠ ' },
    page_new_unsaved:    { ja: 'æ–°è¦è¿½åŠ ï¼ˆæœªä¿å­˜ï¼‰', en: 'New (unsaved)', zh: 'æ–°å¢ï¼ˆæœªä¿å­˜ï¼‰' },
    page_undo:           { ja: 'å…ƒã«æˆ»ã™', en: 'Undo', zh: 'æ’¤é”€' },
    page_invalid_title:  { ja: 'âš ï¸ ãƒªãƒ³ã‚¯ãŒç„¡åŠ¹ã§ã™', en: 'âš ï¸ Invalid Link', zh: 'âš ï¸ é“¾æ¥æ— æ•ˆ' },
    page_invalid_desc:   { ja: 'ã“ã®ãƒªãƒ³ã‚¯ã¯æœŸé™åˆ‡ã‚Œã‹ã€ç„¡åŠ¹ã§ã™ã€‚\næœ€æ–°ã®ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã«å«ã¾ã‚Œã‚‹ãƒªãƒ³ã‚¯ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', en: 'This link has expired or is invalid.\nPlease use the link from your latest notification email.', zh: 'æ­¤é“¾æ¥å·²è¿‡æœŸæˆ–æ— æ•ˆã€‚\nè¯·ä½¿ç”¨æœ€æ–°é€šçŸ¥é‚®ä»¶ä¸­çš„é“¾æ¥ã€‚' },
    page_loading:        { ja: 'èª­ã¿è¾¼ã¿ä¸­...', en: 'Loading...', zh: 'åŠ è½½ä¸­...' },
    page_saving:         { ja: 'ä¿å­˜ä¸­...', en: 'Saving...', zh: 'ä¿å­˜ä¸­...' },
    page_toast_added:    { ja: 'ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼ˆæœªä¿å­˜ï¼‰', en: 'Added to list (unsaved)', zh: 'å·²æ·»åŠ åˆ°åˆ—è¡¨ï¼ˆæœªä¿å­˜ï¼‰' },
    page_exists:         { ja: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™', en: 'This email is already registered', zh: 'è¯¥é‚®ç®±å·²æ³¨å†Œ' },
    page_pending:        { ja: 'ã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«è¿½åŠ äºˆå®šã§ã™', en: 'This email is already pending', zh: 'è¯¥é‚®ç®±å·²åœ¨å¾…æ·»åŠ åˆ—è¡¨ä¸­' },
    page_enter_email:    { ja: 'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', en: 'Please enter an email', zh: 'è¯·è¾“å…¥é‚®ç®±åœ°å€' },
    page_invalid_email:  { ja: 'æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', en: 'Please enter a valid email', zh: 'è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€' },
    page_save_ok:        { ja: 'ã—ã¾ã—ãŸ', en: ' completed', zh: 'å®Œæˆ' },
    page_count_add:      { ja: 'åè¿½åŠ ', en: ' added', zh: 'äººå·²æ·»åŠ ' },
    page_count_del:      { ja: 'åå‰Šé™¤', en: ' removed', zh: 'äººå·²åˆ é™¤' },
    page_save_fail:      { ja: 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', en: 'Save failed', zh: 'ä¿å­˜å¤±è´¥' },
    page_net_err:        { ja: 'é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', en: 'Network error', zh: 'ç½‘ç»œé”™è¯¯' },
    page_del_confirm:    { ja: ' ã‚’å—ä¿¡è€…ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', en: ' â€” Remove from recipients?', zh: ' ä»æ”¶ä»¶äººåˆ—è¡¨ä¸­åˆ é™¤ï¼Ÿ' },
    page_count_unit:     { ja: 'å', en: '', zh: 'äºº' },
    page_load_fail:      { ja: 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', en: 'Failed to load data', zh: 'æ•°æ®åŠ è½½å¤±è´¥' }
  };

  var LANG = 'ja'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ

  function t(key) {
    var entry = I18N[key];
    if (!entry) return key;
    return entry[LANG] || entry['ja'] || key;
  }

  function setLang(langRaw) {
    var l = String(langRaw || '').trim();
    if (l === 'è‹±èª' || l === 'en' || l === 'English') LANG = 'en';
    else if (l === 'ä¸­å›½èª' || l === 'zh' || l === 'ä¸­æ–‡') LANG = 'zh';
    else LANG = 'ja';
    document.documentElement.lang = LANG === 'zh' ? 'zh-CN' : LANG;
  }

  // ===== çŠ¶æ…‹ç®¡ç† =====
  var originalRecipients = [];
  var pendingAdds = [];
  var pendingDeletes = [];

  // ===== åˆæœŸåŒ– =====
  window.onload = function() {
    document.getElementById('initial-loading').textContent = t('page_loading');
    if (!TOKEN) { showError(); return; }
    callAPI('validate_token', { token: TOKEN }, function(data) {
      if (data.success) {
        setLang(data.language || 'æ—¥æœ¬èª');
        applyI18n();
        document.getElementById('awb-display').textContent = data.awb_display;
        document.getElementById('loading-container').style.display = 'none';
        document.getElementById('main-container').style.display = 'block';
        loadRecipients();
      } else {
        showError();
      }
    }, function() { showError(); });
  };

  document.addEventListener('DOMContentLoaded', function() {
    var input = document.getElementById('new-email');
    if (input) input.addEventListener('keydown', function(e) { if (e.key === 'Enter') addEmailLocal(); });
  });

  function applyI18n() {
    document.getElementById('hdr-title').innerHTML = '&#x1F465; ' + t('page_title');
    document.getElementById('hdr-subtitle').textContent = t('page_subtitle');
    document.getElementById('awb-label').textContent = t('page_awb_label');
    document.getElementById('list-title').textContent = 'ğŸ“§ ' + t('page_current');
    document.getElementById('add-title').textContent = 'ï¼‹ ' + t('page_add_title');
    document.getElementById('email-label').textContent = t('page_email_label');
    document.getElementById('add-hint').textContent = t('page_add_hint');
    document.getElementById('btn-add-email').textContent = t('page_add_button');
    document.getElementById('btn-save').textContent = t('page_save');
    document.getElementById('btn-close').textContent = t('page_close');
    document.getElementById('footer-note').textContent = t('page_security');
    document.getElementById('changes-bar').textContent = t('page_unsaved');
    document.getElementById('err-title').innerHTML = t('page_invalid_title');
    document.getElementById('err-desc').innerHTML = t('page_invalid_desc').replace(/\n/g, '<br>');
  }

  function showError() {
    applyI18n();
    document.getElementById('loading-container').style.display = 'none';
    document.getElementById('main-container').style.display = 'none';
    document.getElementById('error-container').style.display = 'block';
  }

  // ===== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ =====
  function loadRecipients() {
    var container = document.getElementById('recipient-container');
    container.innerHTML = '<div class="loading">' + t('page_loading') + '</div>';

    callAPI('list_recipients', { token: TOKEN }, function(data) {
      if (data.success) {
        originalRecipients = data.recipients;
        pendingAdds = [];
        pendingDeletes = [];
        renderAll();
      } else {
        container.innerHTML = '<div class="empty-state">' + t('page_load_fail') + '</div>';
      }
    }, function() {
      container.innerHTML = '<div class="empty-state">' + t('page_net_err') + '</div>';
    });
  }

  // ===== ãƒ­ãƒ¼ã‚«ãƒ«æ“ä½œ =====
  function addEmailLocal() {
    var input = document.getElementById('new-email');
    var email = input.value.trim().toLowerCase();
    if (!email) { showToast(t('page_enter_email'), 'error'); return; }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { showToast(t('page_invalid_email'), 'error'); return; }

    for (var i = 0; i < originalRecipients.length; i++) {
      if (originalRecipients[i].email.toLowerCase() === email && pendingDeletes.indexOf(originalRecipients[i].recipient_id) === -1) {
        showToast(t('page_exists'), 'error'); return;
      }
    }
    for (var j = 0; j < pendingAdds.length; j++) {
      if (pendingAdds[j] === email) { showToast(t('page_pending'), 'error'); return; }
    }

    pendingAdds.push(email);
    input.value = '';
    renderAll();
    showToast(t('page_toast_added'), 'success');
  }

  function markDelete(rid) {
    if (pendingDeletes.indexOf(rid) === -1) pendingDeletes.push(rid);
    renderAll();
  }
  function undoDelete(rid) {
    pendingDeletes = pendingDeletes.filter(function(id) { return id !== rid; });
    renderAll();
  }
  function removeLocalAdd(email) {
    pendingAdds = pendingAdds.filter(function(e) { return e !== email; });
    renderAll();
  }

  // ===== æç”» =====
  function renderAll() {
    var container = document.getElementById('recipient-container');
    var title = document.getElementById('list-title');
    var activeCount = 0;
    var html = '';

    for (var i = 0; i < originalRecipients.length; i++) {
      var r = originalRecipients[i];
      var isDel = pendingDeletes.indexOf(r.recipient_id) !== -1;
      var initial = r.email.charAt(0).toUpperCase();
      var dateStr = r.created_at ? formatDate(r.created_at) : '';

      html += '<div class="recipient-item' + (isDel ? ' deleted' : '') + '">';
      html += '  <div class="recipient-info">';
      html += '    <div class="recipient-avatar">' + esc(initial) + '</div>';
      html += '    <div class="recipient-details">';
      html += '      <div class="recipient-email">' + esc(r.email) + '</div>';
      if (dateStr) html += '      <div class="recipient-date">' + t('page_added_date') + ': ' + esc(dateStr) + '</div>';
      html += '    </div>';
      html += '  </div>';
      if (isDel) {
        html += '  <button class="recipient-undo" onclick="undoDelete(\'' + r.recipient_id + '\')">' + t('page_undo') + '</button>';
      } else {
        html += '  <button class="recipient-delete" onclick="markDelete(\'' + r.recipient_id + '\')" title="Delete">&#x1F5D1;&#xFE0F;</button>';
        activeCount++;
      }
      html += '</div>';
    }

    for (var j = 0; j < pendingAdds.length; j++) {
      var email = pendingAdds[j];
      html += '<div class="recipient-item new-added">';
      html += '  <div class="recipient-info">';
      html += '    <div class="recipient-avatar" style="background-color: #bbf7d0; color: #166534;">' + esc(email.charAt(0).toUpperCase()) + '</div>';
      html += '    <div class="recipient-details">';
      html += '      <div class="recipient-email">' + esc(email) + '</div>';
      html += '      <div class="recipient-date" style="color: #166534;">' + t('page_new_unsaved') + '</div>';
      html += '    </div>';
      html += '  </div>';
      html += '  <button class="recipient-delete" onclick="removeLocalAdd(\'' + esc(email) + '\')" title="Remove">&#x2716;</button>';
      html += '</div>';
      activeCount++;
    }

    if (originalRecipients.length === 0 && pendingAdds.length === 0) {
      html = '<div class="empty-state">' + t('page_no_recipients') + '</div>';
    }

    container.innerHTML = html;
    title.textContent = '\uD83D\uDCE7 ' + t('page_current') + 'ï¼ˆ' + activeCount + t('page_count_unit') + 'ï¼‰';

    var hasChanges = pendingAdds.length > 0 || pendingDeletes.length > 0;
    document.getElementById('changes-bar').className = 'changes-bar' + (hasChanges ? ' visible' : '');
    document.getElementById('btn-save').disabled = !hasChanges;
  }

  // ===== ä¿å­˜ =====
  function saveChanges() {
    if (pendingAdds.length === 0 && pendingDeletes.length === 0) return;
    var btn = document.getElementById('btn-save');
    btn.disabled = true;
    btn.textContent = t('page_saving');

    var apiParams = { token: TOKEN };
    if (pendingAdds.length > 0) apiParams.add_emails = pendingAdds.join(',');
    if (pendingDeletes.length > 0) apiParams.delete_ids = pendingDeletes.join(',');

    callAPI('save_changes', apiParams, function(data) {
      btn.textContent = t('page_save');
      if (data.success) {
        var msg = '';
        if (data.added > 0) msg += data.added + t('page_count_add');
        if (data.deleted > 0) msg += (msg ? 'ã€' : '') + data.deleted + t('page_count_del');
        showToast('âœ“ ' + msg + t('page_save_ok'), 'success');
        loadRecipients();
      } else {
        btn.disabled = false;
        showToast(t('page_save_fail') + ': ' + (data.error || ''), 'error');
      }
    }, function() {
      btn.textContent = t('page_save');
      btn.disabled = false;
      showToast(t('page_net_err'), 'error');
    });
  }

  // ===== API =====
  function callAPI(action, params, onSuccess, onError) {
    var url = GAS_URL + '?action=' + encodeURIComponent(action);
    for (var key in params) {
      if (key !== 'action') url += '&' + encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
    }
    fetch(url, { method: 'GET', redirect: 'follow' })
      .then(function(r) { return r.text(); })
      .then(function(text) {
        try { onSuccess(JSON.parse(text)); }
        catch (e) { if (onError) onError(); }
      })
      .catch(function(err) { if (onError) onError(err); });
  }

  // ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====
  function formatDate(isoStr) {
    try { var d = new Date(isoStr); return (d.getMonth() + 1) + '/' + d.getDate(); }
    catch (e) { return ''; }
  }
  function esc(str) {
    var d = document.createElement('div'); d.textContent = str; return d.innerHTML;
  }
  function showToast(message, type) {
    var el = document.getElementById('toast');
    el.textContent = message;
    el.className = 'toast ' + type + ' active';
    setTimeout(function() { el.className = 'toast'; }, 3000);
  }
</script>

</body>
</html>
